#!/bin/bash

set -eu

JOB_NAME=perm-drop-db
LOG_DIR="/var/vcap/sys/log/${JOB_NAME}"

exec 2> >(tee -a "${LOG_DIR}/${JOB_NAME}.stderr.log")
exec > >(tee -a "${LOG_DIR}/${JOB_NAME}.stdout.log")


MIGRATOR_OPTS="
  --log-level <%= p('log_level') %>
  --db-driver <%= p('sql.db.driver') %>
  --db-host <%= p('sql.db.host') %>
  --db-port <%= p('sql.db.port') %>
  --db-schema <%= p('sql.db.schema') %>
  --db-username <%= p('sql.db.username') %>
  --db-password <%= p('sql.db.password') %>
"

mkdir -p "$LOG_DIR"
chown -R vcap:vcap "$LOG_DIR"

/var/vcap/packages/perm/bin/perm migrate down \
  --all \
  ${MIGRATOR_OPTS}

/var/vcap/packages/perm/bin/perm migrate up \
  ${MIGRATOR_OPTS}
